{% extends 'accounts/stats_asset_edit.html' %}

{% block tabs %}
  <li><a href="#repository" class="active"> Repository
  </a></li>
  {{ block.super }}
{% endblock %}

{% block tab-content %}
  <div id="repository" class="tabset_content">
    <h2 class="tabset_label">Repository</h2>

    <p class="narrow">The {{ user_asset.asset|escape }} project can feed data to CIA in any of the following ways:</p>

    <ol>
      <li>
        <p class="narrow">
          You may already be using a hosting service, like <a href="http://sourceforge.net">SourceForge.net</a>
          or <a href="http://gna.org">Gna!</a>, which provide built-in CIA integration.
        </p>
        <p class="narrow">
          Check with your hosting provider for details. You may need to ensure that CIA and your hosting provider
          use the same project name.
        </p>
      </li>

      <li>
        <p class="narrow">
          You may install a <a href="/doc/clients/">client script</a> in your project's source repository. This
          option provides the fastest response time, and supports the widest variety of revision control systems.
        </p>
        <p class="narrow">
	  Your client script must be configured to use the project name <code>{{ user_asset.asset.get_name|escape }}</code>
	</p>
      </li>

      <li>
        <p class="narrow">
          If your project uses a public <a href="http://subversion.tigris.org/">Subversion</a> repository, the CIA
          server can contact it directly and check for commits. It can poll your server periodically, or it can check
	  for updates in response to 'pings' sent via e-mail. You can add a simple post-commit hook to send these
	  pings, or you can take advantage of an existing mailer script or mailing list.
        </p>
        <p>
	  {{ form.use_repository }}
          <label class="checkbox" for="id_use_repository">Connect to a public Subversion repository</label>
        </p>

	<div id="repository_details">
	  <fieldset><legend>Basic Configuration</legend>

	    <div class="form-row">
	      <label for="id_location">Repository URL:</label>
	      {{ form.location }}
	      <div class="error">{{ form.errors.location.0 }}</div>
	    </div>

	    {% if user_asset.asset.repos %}
	      <p class="note">
		 For best performance, CIA needs to be notified by e-mail when a change is committed to this
		 repository. Send any message to the address <code>{{ user_asset.asset.repos.get_pinger_email|escape }}</code>
		 in order to trigger an update for this project.
	      </p>
	      <p>
		{{ form.forward_pinger_mail }}
		<label class="checkbox" for="id_forward_pinger_mail">Forward mail from 
		  <code>{{ user_asset.asset.repos.get_pinger_email|escape }}</code> to
		  <code>{{ request.user.email|escape }}</code></label>
		<blockquote class="note">
		  This setting may be useful to enable temporarily if you're trying to subscribe
		  the above email address to an existing mailing list, and you need to confirm the
		  subscription.
		</blockquote>
	      </p>
	      <p>
		{{ form.enable_polling }}
		<label class="checkbox" for="id_enable_polling">Poll for changes every</label>
		{{ form.poll_frequency }}
		{% if form.errors.poll_frequency %}
		   <span class="error">&laquo; {{ form.errors.poll_frequency.0 }}</span>
		{% endif %}
		minutes
		<blockquote class="note">
		  If you have no way of sending e-mail notifications, or if your e-mail notifications
		  may be unreliable, you can use polling as a backup. Note that this will increase the
		  load on your Subversion server, and you may have to wait several minutes for new commits
		  to be announced if you rely only on polling.
		</blockquote>
	      </p>
	    {% endif %}
	  </fieldset>

	  {% if user_asset.asset.repos %}
	    <fieldset><legend>Advanced Options</legend>

	      <div class="form-row">
		<label for="id_revision_url">Revision URL patttern:</label>
		{{ form.revision_url }}
		<div class="error">{{ form.errors.revision_url.0 }}</div>
                <p class="note">
                  This optional setting allows you to give each CIA commit message a URL which points to additional
		  information about that change. These URLs show up on your project's
                  <a href="http://{{ request.META.HTTP_HOST }}/stats/{{ user_asset.asset.target.path|urlencode|escape }}">stats page</a>
		  and RSS feed, and they can optionally be displayed by IRC bots.
		  You can use this to integrate CIA with tools
		  like <a href="http://websvn.tigris.org/">WebSVN</a> and <a href="http://trac.edgewall.org/">Trac</a>.
		</p>
		<p class="note">
		  Placeholders like <code>{project}</code>, <code>{author}</code>, and <code>{revision}</code>
		  are substituted appropriately for each commit. For example:
		</p>
		<p class="note">
		  <code>http://svn.sourceforge.net/viewvc/{project}?view=rev&amp;revision={revision}</code>
		</p>
	      </div>

	      <div class="form-row">
		<label for="id_path_regexes">Path regex list:</label>
		{{ form.path_regexes }}
		<p class="error">{{ form.errors.path_regexes.0 }}</p>
                <p class="note">
		  This is a list of regular expressions, one per line, which lets CIA automatically extract
                  branch and module information from file paths in your Subversion repository. Each regular
		  expression contains named groups for extracting module and/or branch names. Whitespace
		  in the pattern is ignored.
		</p>
                <p class="note">
		  The regular expressions are tested in the order specified. If the regex matches every path
		  in the commit with identical results, the extracted information is added to the commit
		  and the matched portion of each path is removed.
		</p>
                <p class="note">
		  For example, the following regex list would be
		  appropriate for repositories with paths of the form
		  "trunk/module-name/..."  and "branches/module-name/branch-name/...":
		</p>
                <p class="note">
		  <pre class="code">^trunk/ (?P&lt;module>[^/]+)/
^(branches|tags)/ (?P&lt;module>[^/]+)/ (?P&lt;branch>[^/]+)/</pre>
		</p>
	    </fieldset>

	    <fieldset><legend>Repository Status</legend>
	    </fieldset>
	  {% endif %}

        </div>
      </li>
    </ol>
  </div>
  {{ block.super }}
{% endblock %}

{% block scripts-init %}
  {{ block.super }}
  autohideWithCheckbox("id_use_repository", "repository_details");
{% endblock %}
